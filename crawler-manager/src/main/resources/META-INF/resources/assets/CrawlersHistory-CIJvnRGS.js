import{d as B,a as H,_ as U}from"./index-DZVWbUD3.js";import{g as R,A as F,D as E}from"./primevue-COZmI4QV.js";import{s as S}from"./index-CMl7L9aA.js";import{s as N}from"./index-RJ29EJqU.js";import{a as O,J as T}from"./JobHistory-DvKQfOan.js";import{d as P}from"./debounce-BMmXVQ06.js";import{M as q,r as c,B as m,o as z,h as G,i as r,v as o,N as d,s as A,f as K}from"./vendor-Mr6oR_SG.js";import"./index-DY9hXYNa.js";const Q={class:"crawlers-history"},W={class:"page-header"},X={class:"header-actions"},Y={class:"filters-grid"},Z={class:"field"},ee={class:"field"},ae={class:"field"},te={class:"field"},le=q({__name:"CrawlersHistory",setup(re){const h=B(),n=H(),p=c(!1),v=c(!1),f=c(!1),b=c(null),l=c({crawlerId:null,status:null,dateRange:null,search:""}),g=c([]),M=m(()=>h.crawlers),x=m(()=>[...M.value.map(a=>({id:a.id,name:a.name}))]),I=m(()=>[{label:"Completed",value:"completed"},{label:"Running",value:"running"},{label:"Failed",value:"failed"},{label:"Cancelled",value:"cancelled"},{label:"Pending",value:"pending"}]),C=m(()=>{let a=[...g.value];if(l.value.crawlerId&&(a=a.filter(e=>e.crawlerId===l.value.crawlerId)),l.value.status&&(a=a.filter(e=>e.status===l.value.status)),l.value.dateRange&&l.value.dateRange.length===2){const[e,t]=l.value.dateRange;a=a.filter(s=>{const i=new Date(s.startedAt);return i>=e&&i<=t})}if(l.value.search){const e=l.value.search.toLowerCase();a=a.filter(t=>{var s,i;return t.id.toLowerCase().includes(e)||((s=t.crawlerName)==null?void 0:s.toLowerCase().includes(e))||((i=t.url)==null?void 0:i.toLowerCase().includes(e))})}return a}),y=async()=>{v.value=!0;try{await D(),n.add({severity:"success",summary:"Success",detail:"Job history refreshed successfully",life:3e3})}catch{n.add({severity:"error",summary:"Error",detail:"Failed to refresh job history",life:5e3})}finally{v.value=!1}},_=async()=>{try{const a=C.value.map(t=>({id:t.id,crawler:t.crawlerName,status:t.status,startedAt:t.startedAt,completedAt:t.completedAt,duration:t.duration,articlesFound:t.articlesFound,url:t.url})),e=$(a);k(e,"crawler-history.csv"),n.add({severity:"success",summary:"Export Complete",detail:"Job history exported successfully",life:3e3})}catch{n.add({severity:"error",summary:"Export Failed",detail:"Failed to export job history",life:5e3})}},$=a=>{if(a.length===0)return"";const e=Object.keys(a[0]);return[e.join(","),...a.map(s=>e.map(i=>{const u=s[i];return typeof u=="string"&&u.includes(",")?`"${u}"`:u}).join(","))].join(`
`)},k=(a,e)=>{const t=new Blob([a],{type:"text/csv;charset=utf-8;"}),s=document.createElement("a"),i=URL.createObjectURL(t);s.setAttribute("href",i),s.setAttribute("download",e),s.style.visibility="hidden",document.body.appendChild(s),s.click(),document.body.removeChild(s)},w=()=>{},L=P(()=>{},300),j=a=>{b.value=a,f.value=!0},V=async a=>{try{await new Promise(e=>setTimeout(e,1e3)),n.add({severity:"success",summary:"Job Retried",detail:`Job ${a} has been queued for retry`,life:3e3}),await y()}catch{n.add({severity:"error",summary:"Retry Failed",detail:`Failed to retry job ${a}`,life:5e3})}},J=async a=>{try{await new Promise(e=>setTimeout(e,500)),n.add({severity:"success",summary:"Job Cancelled",detail:`Job ${a} has been cancelled`,life:3e3}),await y()}catch{n.add({severity:"error",summary:"Cancel Failed",detail:`Failed to cancel job ${a}`,life:5e3})}},D=async()=>{g.value=Array.from({length:20},(a,e)=>({id:`job-${e+1}`,crawlerId:e%2===0?"drucker":"caspit",crawlerName:e%2===0?"Drucker Crawler":"Caspit Crawler",status:["completed","running","failed","cancelled"][Math.floor(Math.random()*4)],startedAt:new Date(Date.now()-Math.random()*7*24*60*60*1e3).toISOString(),completedAt:Math.random()>.3?new Date(Date.now()-Math.random()*6*24*60*60*1e3).toISOString():null,duration:Math.floor(Math.random()*120)+30,articlesFound:Math.floor(Math.random()*50)+5,url:`https://example.com/article-${e+1}`}))};return z(async()=>{p.value=!0;try{await Promise.all([h.loadCrawlerData(),D()])}catch{n.add({severity:"error",summary:"Load Failed",detail:"Failed to load history data",life:5e3})}finally{p.value=!1}}),(a,e)=>(K(),G("div",Q,[r("div",W,[e[5]||(e[5]=r("div",{class:"header-content"},[r("h1",{class:"page-title"},"Crawlers History"),r("p",{class:"page-description"},"View crawler job history and details")],-1)),r("div",X,[o(d(R),{icon:"pi pi-refresh",label:"Refresh",onClick:y,loading:v.value,severity:"secondary"},null,8,["loading"]),o(d(R),{icon:"pi pi-download",label:"Export",onClick:_,severity:"primary"})])]),o(d(F),{class:"filters-card"},{content:A(()=>[r("div",Y,[r("div",Z,[e[6]||(e[6]=r("label",{for:"crawler-filter"},"Crawler",-1)),o(d(S),{id:"crawler-filter",modelValue:l.value.crawlerId,"onUpdate:modelValue":e[0]||(e[0]=t=>l.value.crawlerId=t),options:x.value,optionLabel:"name",optionValue:"id",placeholder:"All Crawlers",showClear:"",onChange:w},null,8,["modelValue","options"])]),r("div",ee,[e[7]||(e[7]=r("label",{for:"status-filter"},"Status",-1)),o(d(S),{id:"status-filter",modelValue:l.value.status,"onUpdate:modelValue":e[1]||(e[1]=t=>l.value.status=t),options:I.value,optionLabel:"label",optionValue:"value",placeholder:"All Statuses",showClear:"",onChange:w},null,8,["modelValue","options"])]),r("div",ae,[e[8]||(e[8]=r("label",{for:"date-range"},"Date Range",-1)),o(d(N),{id:"date-range",modelValue:l.value.dateRange,"onUpdate:modelValue":e[2]||(e[2]=t=>l.value.dateRange=t),selectionMode:"range",dateFormat:"yy-mm-dd",showButtonBar:"",onDateSelect:w},null,8,["modelValue"])]),r("div",te,[e[9]||(e[9]=r("label",{for:"search"},"Search",-1)),o(d(E),{id:"search",modelValue:l.value.search,"onUpdate:modelValue":e[3]||(e[3]=t=>l.value.search=t),placeholder:"Search jobs...",onInput:d(L)},null,8,["modelValue","onInput"])])])]),_:1}),o(d(F),{class:"history-table-card"},{content:A(()=>[o(T,{jobs:C.value,loading:p.value,crawlerId:"all",onViewDetails:j,onRetryJob:V,onCancelJob:J},null,8,["jobs","loading"])]),_:1}),o(O,{visible:f.value,"onUpdate:visible":e[4]||(e[4]=t=>f.value=t),job:b.value||{id:"",status:"pending",startedAt:"",crawlerId:""},onRetry:V,onCancel:J},null,8,["visible","job"])]))}}),pe=U(le,[["__scopeId","data-v-a577c49e"]]);export{pe as default};
